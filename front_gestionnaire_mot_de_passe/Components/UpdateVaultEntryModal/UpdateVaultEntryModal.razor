@inject Interop.CryptoInterop Crypto
@using front_gestionnaire_mot_de_passe.Models


@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Modifier l'√©l√©ment</h2>

            <div class="form-group">
                <label>Nom d‚Äôutilisateur</label>
                <input id="ce-username" />
            </div>

            <div class="form-group">
                <label>Mot de passe</label>

                <div style="display:flex; gap:.5rem; align-items:center;">
                    <input id="ce-password"
                           type="@(_showPassword ? "text" : "password")"
                           autocomplete="new-password"
                           style="flex:1;" />

                    <button class="show_password_button" type="button" @onclick="TogglePasswordVisibility">
                        @(_showPassword ? "üôà" : "üëÅÔ∏è")
                    </button>

                    
                </div>
                
            </div>
            
            <button class="form_group_button" type="button" @onclick="GeneratePassword">
                üîÑ  G√©n√©rer un mot de passe
            </button>
            
            <div class="form-group">
                <label>URL</label>
                <input id="ce-url" />
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="ce-notes" rows="3"></textarea>
            </div>
            
            @* <PasswordStrengthMeter Password="@_password" /> *@

            <div class="modal-actions">
                <button @onclick="SubmitUpdateForm">Enregistrer</button>
                <button @onclick="CloseModal">Annuler</button>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <p style="color:red;margin-top:.5rem">@_error</p>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnUpdated { get; set; }
    [Parameter] public int EntryId { get; set; }
    [Parameter] public VaultEntry? Entry { get; set; }
    
    private string? _error;
    private bool _showPassword;
    private bool _hasFilled;
    private bool _prevVisible;

    protected override void OnParametersSet()
    {
        if (IsVisible && !_prevVisible)
        {
            _hasFilled = false;
        }
        _prevVisible = IsVisible;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_hasFilled && Entry != null)
        {
            _hasFilled = true;
            try
            {
                // Petit d√©lai pour s'assurer que le DOM est pr√™t
                await Task.Delay(100);
                await Crypto.FillUpdateModalAsync(Entry.VaultId, Entry);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erreur lors du remplissage du modal de mise √† jour: {ex.Message}");
            }
        }
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }
    
    private async Task GeneratePassword()
    {
        await Crypto.GenerateAndFillPasswordAsync("ce-password", 16);
    }
    
    
    private async Task CloseModal()
    {
        _error = null;
        if (OnClose.HasDelegate) await OnClose.InvokeAsync();
    }
    
    private async Task SubmitUpdateForm()
    {
        _error = null;

        if (EntryId <= 0) { _error = "VaultId manquant."; return; }

        try
        {
            var ok = await Crypto.UpdateEntryFromModalAsync(EntryId);
            if (ok)
            {
                if (OnUpdated.HasDelegate) await OnUpdated.InvokeAsync();
                await CloseModal();
            }
            else
            {
                _error = "√âchec lors de la cr√©ation de l‚Äôentr√©e.";
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
    
}




