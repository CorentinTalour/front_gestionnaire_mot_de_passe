@using front_gestionnaire_mot_de_passe.Models
@rendermode InteractiveServer
@inject front_gestionnaire_mot_de_passe.Interop.CryptoInterop Crypto
@inject Microsoft.Identity.Abstractions.IDownstreamApi DownstreamApi
@using front_gestionnaire_mot_de_passe.Components.UpdateVaultEntryModal

<div class="display-card">
    <div class="display-card-header">
        <img src="cle_icon.jpg" alt="Ic√¥ne de cl√©" class="vault-key-icon" />
        <div class="display-info">
            <p><strong>Entr√©e #@Entry.Id</strong></p>
        </div>
    </div>
    
    <div class="display-actions">
        <button class="consult-btn" type="button" @onclick="ShowUpdateModal">Modifier</button>
    </div>

    <div class="display-actions">
        <button class="consult-btn" type="button" @onclick="OpenModalAsync">Consulter</button>
    </div>
</div>

@if (_showModal)
{
    <div class="modal-layout" @onclick="CloseModal">
        <section class="entry-details" @onclick:stopPropagation="true">
            <div class="entry-button">
                <button class="entry-back-button" type="button" @onclick="CloseModal">
                    ‚Üê Retour au coffre
                </button>
                
                <button class="entry-back-button" type="button" @onclick="DeleteVaultEntry">
                    Supprimer l'√©l√©ment
                </button>
            </div>

            <div class="entry-card">
                <h2><span id="@DomId("name")">‚Ä¶</span></h2>

                <p>
                    <strong>Nom d'utilisateur :</strong>
                    <span id="@DomId("username")">‚Ä¶</span>
                </p>

                <div class="pwd-row">
                    <div class="pwd-left">
                        <strong>Mot de passe :</strong>
                        <span id="@DomId("password")">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                    </div>

                    <div class="pwd-actions">
                        <button type="button" class="toggle-btn" @onclick="TogglePasswordAsync">üëÅÔ∏è</button>
                        <button type="button" class="copy-btn" @onclick="CopyPasswordAsync">Copier</button>
                    </div>
                </div>

                <p>
                    <strong>Note :</strong>
                    <span id="@DomId("notes")">‚Ä¶</span>
                </p>

                <p>
                    <strong>URL :</strong>
                    <span id="@DomId("url")">‚Ä¶</span>
                </p>

                <p><strong>Cr√©√© le :</strong> @Entry.CreatedAt.ToString("g")</p>
                <p><strong>Mis √† jour le :</strong> @(FormatUpdatedAt())</p>
                <p><strong>ID du coffre :</strong> @Entry.VaultId</p>

                @if (!string.IsNullOrWhiteSpace(_error))
                {
                    <p class="error-text">@_error</p>
                }
            </div>
        </section>
    </div>
    
}
<UpdateVaultEntryModal IsVisible="@_isUpdateModalVisible"
                       VaultId="@VaultId"
                       OnClose="HideUpdateModal" />

@code {
    [Parameter, EditorRequired] public VaultEntry Entry { get; set; } = default!;
    [Parameter] public int VaultId { get; set; }
    [Parameter] public EventCallback OnDeleted { get; set; }

    private bool _showModal;
    private bool _needDecrypt;
    private string? _error;
    private bool _isUpdateModalVisible;

    private readonly string _uid = Guid.NewGuid().ToString("N");
    private string DomId(string field) => $"entry-{Entry.Id}-{_uid}-{field}";

    private async Task OpenModalAsync()
    {
        _error = null;
        _showModal = true;
        _needDecrypt = true;
        await InvokeAsync(StateHasChanged);
    }
    
    private void ShowUpdateModal()
    {
        _isUpdateModalVisible = true;
    }
    
    private async Task HideUpdateModal()
    {
        _isUpdateModalVisible = false;
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_showModal && _needDecrypt)
        {
            _needDecrypt = false;

            try
            {
                await Crypto.DecryptEntryToDomAsync(VaultId, Entry, new
                {
                    nameId = DomId("name"),
                    usernameId = DomId("username"),
                    passwordId = DomId("password"),
                    urlId = DomId("url"),
                    notesId = DomId("notes")
                });
            }
            catch (Exception ex)
            {
                _error = ex.Message;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void CloseModal()
    {
        _error = null;
        _showModal = false;
    }

    private async Task CopyPasswordAsync()
    {
        try
        {
            await Crypto.CopyDomTextToClipboardAsync(DomId("password"));
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private string FormatUpdatedAt()
    {
        var prop = Entry.GetType().GetProperty("UpdatedAt");
        var val = prop?.GetValue(Entry);

        if (val is DateTime dt) return dt.ToString("g");
        if (val is DateTimeOffset dto) return dto.LocalDateTime.ToString("g");

        return val?.ToString() ?? "Aucune mise √† jour";
    }
    
    private async Task TogglePasswordAsync()
    {
        try
        {
            await Crypto.TogglePasswordVisibilityAsync(DomId("password"));
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task DeleteVaultEntry()
    {
        _error = null;

        try
        {
            HttpResponseMessage res = await DownstreamApi.CallApiForUserAsync(
                "DownstreamApi",
                options =>
                {
                    options.HttpMethod = HttpMethod.Delete.Method;
                    options.RelativePath = $"/Entry?entryId={Entry.Id}";
                });
            
            if (OnDeleted.HasDelegate)
                await OnDeleted.InvokeAsync(); 

            if (!res.IsSuccessStatusCode)
            {
                string body = await res.Content.ReadAsStringAsync();
                _error = $"DELETE √©chou√©: {(int)res.StatusCode} {res.ReasonPhrase} {body}";
                return;
            }
            
            CloseModal();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
}