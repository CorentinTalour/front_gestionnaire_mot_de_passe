@inject Interop.CryptoInterop Crypto
@inject IJSRuntime JS

@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Modifier le coffre</h2>
            <div class="form-tabs">
                <button @onclick="() => _activeTab = 0" 
                        class="@(_activeTab == 0 ?  "active" : "")">
                    Informations
                </button>
                <button @onclick="() => _activeTab = 1" 
                        class="@(_activeTab == 1 ? "active" : "")">
                    Changer mot de passe
                </button>
            </div>

            @if (_activeTab == 0)
            {
                <!-- Modifier le nom -->
                <div class="form-group">
                    <label>Nom du coffre :</label>
                    <input type="text" @bind="_vaultName" />
                </div>

                <div class="modal-actions">
                    <button  @onclick="SubmitUpdateNameForm">Mettre Ã  jour le nom</button>
                    <button @onclick="CloseModal">Annuler</button>
                </div>
            }
            else
            {
                <!-- Changer le mot de passe -->
                <div class="form-group">
                    <label>Ancien mot de passe :</label>
                    <input type="password" id="old-password" />
                </div>

                <div class="form-group">
                    <label>Nouveau mot de passe :</label>
                    <input type="password" id="new-password" />
                </div>

                <div class="form-group">
                    <label>Confirmer le nouveau mot de passe :</label>
                    <input type="password" id="confirm-password" />
                </div>

                <div class="modal-actions">
                    <button @onclick="SubmitChangePasswordForm">Changer le mot de passe</button>
                    <button @onclick="CloseModal">Annuler</button>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public int VaultId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnUpdated { get; set; }

    private string _vaultName = string.Empty;
    private int _activeTab;  // 0 = Infos, 1 = Mot de passe

    private async Task CloseModal()
    {
        if (OnClose. HasDelegate)
            await OnClose.InvokeAsync(null);
    }

    private async Task SubmitUpdateNameForm()
    {
        await JS.InvokeVoidAsync(
            "alert",
            "ðŸ”’ Le bouton est dÃ©sactivÃ© car la modification du mot du nom nâ€™est pas encore disponible."
        );
    }

    private async Task SubmitChangePasswordForm()
    {
        try
        {
            bool success = await Crypto.ChangeVaultPasswordFromModalAsync(VaultId);

            if (success)
            {
                if (OnUpdated.HasDelegate)
                    await OnUpdated. InvokeAsync(VaultId);

                await CloseModal();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine("Erreur changement mot de passe:  " + ex.Message);
        }
    }

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            _vaultName = string.Empty;
            _activeTab = 0;
        }
    }
}