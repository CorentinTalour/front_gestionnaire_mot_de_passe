@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Identity.Web
@using front_gestionnaire_mot_de_passe.Components.PasswordStrengthMeter
@using front_gestionnaire_mot_de_passe.Models
@attribute [Authorize]
@attribute [AuthorizeForScopes(Scopes = new[] { "api://b8f83755-0f15-42f5-9a43-cedf7cc50c0a/access_as_user" })]
@inject ITokenAcquisition TokenAcquisition
@inject Interop.CryptoInterop Crypto
@using front_gestionnaire_mot_de_passe.Interop
@inject CryptoInterop CryptoInterop;


@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Cr√©er un nouveau coffre</h2>
            <div class="form-group">
                <label>Nom du coffre :</label>
                <input type="text" @bind="_vaultName" />
            </div>
            <div class="form-group">
                <label>Mot de passe :</label>
                <input
                    @ref="_passwordInputRef"
                    type="@(_showPassword ? "text" : "password")"
                    @bind="_vaultPassword" />
                <button class="show_password_button"  @onclick="TogglePasswordVisibility">
                    @(_showPassword ? "üôà" : "üëÅÔ∏è")
                </button>
                
                <div class="password-strength-container">
                    <div class="strength-bar"></div>
                    <p class="strength-text"></p>
                </div>
            </div>
            <div>
                
                
            </div>
            <div class="modal-actions">
                <button @onclick="SubmitForm">Cr√©er</button>
                <button @onclick="CloseModal">Annuler</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<int> OnCreated { get; set; }
    [Parameter] public Vault VaultData { get; set; } = default!;
    
    private bool _tokenPushed;
    private string _vaultName = string.Empty;
    private string _vaultPassword = string.Empty;
    private bool _showPassword = false;
    private ElementReference _passwordInputRef;
    private bool _meterInitialized;
    
    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_tokenPushed)
        {
            var token = await TokenAcquisition.GetAccessTokenForUserAsync(new[]
            {
                "api://b8f83755-0f15-42f5-9a43-cedf7cc50c0a/access_as_user"
            });

            await Crypto.SetApiAccessTokenAsync(token);
            _tokenPushed = true;
        }
        
        if (IsVisible && !_meterInitialized)
        {
            try
            {
                // Petit d√©lai pour s'assurer que le DOM est pr√™t
                await Task.Delay(100);
                await CryptoInterop.InitPasswordStrengthMeterAsync(_passwordInputRef);
                Console.WriteLine(_passwordInputRef);
                _meterInitialized = true;
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Erreur lors de l'initialisation du password meter: {ex.Message}");
            }
        }
    }

    private async Task SubmitForm()
    {
        try
        {
            JsonElement json = await Crypto.CreateVaultFromModalAsync(600_000, "https://localhost:7115");

            int newId = 0;
            if (json.TryGetProperty("vaultId", out var v)) newId = v.GetInt32();
            else if (json.TryGetProperty("id", out var i)) newId = i.GetInt32();

            Console.WriteLine($"Vault cr√©√©: id={newId}");

            // Pr√©viens le parent
            if (newId != 0 && OnCreated.HasDelegate)
                await OnCreated.InvokeAsync(newId);

            await CloseModal();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine("Erreur cr√©ation vault: " + ex.Message);
        }
    }

    private async Task CloseModal()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync(null);
        
        _meterInitialized = false;
    }
}