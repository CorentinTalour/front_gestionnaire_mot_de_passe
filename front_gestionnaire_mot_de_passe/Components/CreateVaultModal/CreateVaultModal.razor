@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Identity.Web
@attribute [Authorize]
@attribute [AuthorizeForScopes(Scopes = new[] { "api://b8f83755-0f15-42f5-9a43-cedf7cc50c0a/access_as_user" })]
@inject ITokenAcquisition TokenAcquisition
@inject Interop.CryptoInterop Crypto

@if (IsVisible)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h2>Créer un nouveau coffre</h2>
            <div class="form-group">
                <label>Nom du coffre :</label>
                <input type="text" @bind="_vaultName" />
            </div>
            <div class="form-group">
                <label>Mot de passe :</label>
                <input type="password" @bind="_vaultPassword" />
            </div>
            <div class="modal-actions">
                <button @onclick="SubmitForm">Créer (inactif)</button>
                <button @onclick="CloseModal">Annuler</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<int> OnCreated { get; set; }
    
    private bool _tokenPushed;
    private string _vaultName = string.Empty;
    private string _vaultPassword = string.Empty;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_tokenPushed)
        {
            var token = await TokenAcquisition.GetAccessTokenForUserAsync(new[]
            {
                "api://b8f83755-0f15-42f5-9a43-cedf7cc50c0a/access_as_user"
            });

            await Crypto.SetApiAccessTokenAsync(token);
            _tokenPushed = true;
        }
    }

    private async Task SubmitForm()
    {
        try
        {
            JsonElement json = await Crypto.CreateVaultFromModalAsync(600_000, "https://localhost:7115");

            int newId = 0;
            if (json.TryGetProperty("vaultId", out var v)) newId = v.GetInt32();
            else if (json.TryGetProperty("id", out var i)) newId = i.GetInt32();

            Console.WriteLine($"Vault créé: id={newId}");

            // Préviens le parent
            if (newId != 0 && OnCreated.HasDelegate)
                await OnCreated.InvokeAsync(newId);

            await CloseModal();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine("Erreur création vault: " + ex.Message);
        }
    }

    private async Task CloseModal()
    {
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync(null);
    }
}
