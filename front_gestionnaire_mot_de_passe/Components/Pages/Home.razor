@page "/"
@using front_gestionnaire_mot_de_passe.Components.CreateVaultModal
@using front_gestionnaire_mot_de_passe.Components.DisplayError
@using front_gestionnaire_mot_de_passe.Components.OpenVaultModal
@using front_gestionnaire_mot_de_passe.Components.VaultDisplay
@using front_gestionnaire_mot_de_passe.Models
@using Microsoft.Identity.Abstractions
@inject IDownstreamApi DownstreamApi
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="home">

    <section class="upper_part">
        <div class="create_vault_zone">
            <button class="create-btn" @onclick="ShowModal">Créer un coffre</button>
        </div>

        <div class="search_bar_zone">
            <div class="search-container">
                <input type="text"
                       placeholder="Rechercher..."
                       class="search-input"
                       @bind="_searchText"
                       @bind:event="oninput" />
                <div class="search-btn">🔍 Recherchez un coffre fort</div>
                <button class="clear-btn" @onclick="ClearSearch">✖</button>
            </div>
        </div>
    </section>

    @if (FilteredVaults.Any())
    {
        @foreach (var vault in FilteredVaults)
        {
            <VaultCard VaultData="vault" OnOpenVault="OpenVault" />
        }
    }
    else
    {
        <DisplayError />
    }

    <CreateVaultModal IsVisible="@_isModalVisibleCreateVault" OnClose="HideModal" />
    
    @if (_selectedVault is not null)
    {
        <OpenVaultModal 
            IsVisible="@_isOpenVaultVisible"
            VaultId="@_selectedVault.Id"
            VaultSalt="@_selectedVault.Salt"
            VaultIterations="@_selectedVault.NbIteration"
            OnClose="CloseVault"
        />
    }

</div>

@code {
    private string _searchText = string.Empty;
    private bool _isModalVisibleCreateVault = false;
    
    private List<Vault> _vaults = new();

    private IEnumerable<Vault> FilteredVaults =>
        _vaults.Where(v => string.IsNullOrWhiteSpace(_searchText)
                          || v.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    private void ClearSearch() => _searchText = string.Empty;
    private void ShowModal() => _isModalVisibleCreateVault = true;
    private void HideModal() => _isModalVisibleCreateVault = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _vaults = await DownstreamApi.GetForUserAsync<List<Vault>>(
                "DownstreamApi",
                options => options.RelativePath = "/Vault"
            ) ?? new List<Vault>();

            Console.WriteLine($"✅ {_vaults.Count} coffres chargés.");
            foreach (var v in _vaults)
            {
                Console.WriteLine($"Id: {v.Id}, Name: {v.Name}, Salt: {v.Salt}, Password: ********, CreatedAt: {v.CreatedAt}, UpdatedAt: {v.UpdatedAt}, UserId: {v.UserId}");
            }
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"❌ Erreur HTTP: {ex.StatusCode} — {ex.Message}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Erreur lors du chargement des coffres : {ex.Message}");
        }
    }
    
    private Vault? _selectedVault;
    private bool _isOpenVaultVisible;

    private void OpenVault(Vault vault)
    {
        _selectedVault = vault;
        _isOpenVaultVisible = true;
    }

    private void CloseVault()
    {
        _isOpenVaultVisible = false;
        _selectedVault = null;
    }
}