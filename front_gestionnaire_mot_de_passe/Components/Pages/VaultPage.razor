@page "/VaultPage/{id:int}"

@using front_gestionnaire_mot_de_passe.Components.Displayer
@using front_gestionnaire_mot_de_passe.Components.CreateVaultEntryModal
@using front_gestionnaire_mot_de_passe.Models
@using front_gestionnaire_mot_de_passe.Components.DeleteVaultModal
@using front_gestionnaire_mot_de_passe.Components.EditMembers
@using front_gestionnaire_mot_de_passe.Components.OpenVaultModal
@using front_gestionnaire_mot_de_passe.Components.UpdateVaultModal
@using front_gestionnaire_mot_de_passe.Services
@inject IVaultService VaultService
@inject IEntryService EntryService
@inject IUsersService UsersService
@inject NavigationManager Navigation
@inject Interop.CryptoInterop Crypto
@inject ILogger<VaultPage> Logger
@rendermode InteractiveServer


    <PageTitle>Détails du coffre</PageTitle>


    <section class="menu_vault">
        <div class="menu_vault_top">
            <button type="button" class="menu_button_create" @onclick="ShowModal">+</button>            
            <CreateVaultEntryModal IsVisible="@_isModalVisible"
                                   VaultId="@Id"
                                   OnClose="HideModal"
                                   OnCreated="ReloadEntriesAsync" />
            
            @if (VaultData != null && VaultData.IsOwner)
            {
                <button @onclick="() => _isEditingMembers = true" class="menu_button_share">Gérer les membres</button>
            }
        </div>

        <h2 class="menu_title">Votre coffre fort @(VaultData?.Name)</h2>

        <div class="menu_vault_bottom">
            
        @if (VaultData != null && VaultData.IsOwner)
        {
            <button class="menu_button_update_vault"
                    @onclick="ShowUpdateVaultModal">
                Modifier coffre
            </button>
        }
        
        @if (VaultData != null && VaultData.IsOwner)
        {
            <button type="button" class="menu_button_delete_vault" @onclick="ShowDeleteModal">Supprimer coffre-fort</button>
        }
        </div>
    </section>
    
    <h3 class="vault_title">Liste des mots de passe</h3>

    <UpdateVaultModal IsVisible="@_isUpdateVaultModalVisible"
                      VaultId="@Id"
                      OnClose="HideUpdateVaultModal"
                      OnUpdated="ReloadEntriesAsync" />

    @if (_isEditingMembers)
    {
        <ModalEditMembers VaultId="@Id" OnClose="@(() => _isEditingMembers = false)" />
    }
    
<section class="display_entries_zone">
    @if (_entries is null)
    {
        <p>Chargement…</p>
    }
    else if (_entries.Count == 0)
    {
        <p>Aucune entrée.</p>
    }
    else
    {
        @foreach (var e in _entries)
        {
            <Displayer Entry="e" VaultId="@Id" OnDeleted="ReloadEntriesAsync" OnUpdated="ReloadEntriesAsync" IsOwner="@(VaultData?.IsOwner ?? false)"/>
        }
    }
</section>

    <DeleteVaultModal IsVisible="@_isDeleteModalVisible"
                      OnClose="HideDeleteModal"
                      OnConfirm="DeleteVault" />

@if (_isReopenModalVisible)
{
    <OpenVaultModal IsVisible="true"
                    VaultId="@Id"
                    VaultData="@VaultData"
                    VaultSalt="@VaultData?.Salt"
                    VaultIterations="@VaultData?.NbIteration"
                    OnClose="OnReopenModalClose" />
}

@code {
    [Parameter] public int Id { get; set; }
    private Vault? VaultData { get; set; }
    private List<VaultEntry>? _entries;
    private bool _isModalVisible;
    private bool _isDeleteModalVisible;
    private bool _isReopenModalVisible;
    private bool _isUpdateVaultModalVisible;
    private bool _isEditingMembers;

    private void ShowModal()
    {
        _isModalVisible = true;
    }
    
    private void HideModal() => _isModalVisible = false;
    
    private void ShowUpdateVaultModal()
    {
        _isUpdateVaultModalVisible = true;
    }
    
    private void HideUpdateVaultModal()
    {
        _isUpdateVaultModalVisible = false;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var currentUser = await UsersService.GetCurrentUserAsync();
            VaultData = await VaultService.GetVaultByIdAsync(Id, currentUser?.Id);
            
            if (VaultData == null)
            {
                Logger.LogWarning("Coffre {VaultId} introuvable", Id);
                return;
            }
            
            _entries = await EntryService.GetEntriesByVaultIdAsync(Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement du coffre {VaultId}", Id);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Vérifier si le coffre est ouvert en RAM (JS)
            var isOpen = await Crypto.IsVaultOpenAsync(Id);
            if (!isOpen)
            {
                // Si pas ouvert (ex: refresh page), on demande le mot de passe
                _isReopenModalVisible = true;
                StateHasChanged();
            }
        }
    }

    private async Task OnReopenModalClose()
    {
        _isReopenModalVisible = false;
        // Recharger les entrées après l'ouverture du coffre
        await ReloadEntriesAsync();
        StateHasChanged();
    }
    
    private void ShowDeleteModal()
    {
        _isDeleteModalVisible = true;
    }

    private void HideDeleteModal()
    {
        _isDeleteModalVisible = false;
    }

    private async Task ReloadEntriesAsync()
    {
        _entries = await EntryService.GetEntriesByVaultIdAsync(Id);
        StateHasChanged();
    }

    private async Task DeleteVault()
    {
        try
        {
            await VaultService.DeleteVaultAsync(Id);
            _isDeleteModalVisible = false;
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la suppression du coffre {VaultId}", Id);
            // TODO: Afficher un message d'erreur à l'utilisateur
        }
    }
}