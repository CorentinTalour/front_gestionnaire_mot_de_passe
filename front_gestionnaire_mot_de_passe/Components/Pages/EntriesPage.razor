@page "/EntriesPage/{id:int}"
@using front_gestionnaire_mot_de_passe.Models
@using front_gestionnaire_mot_de_passe.Services
@inject IEntryService EntryService
@inject NavigationManager Navigation
@inject ILogger<EntriesPage> Logger
@rendermode InteractiveServer

<PageTitle>Détails de l’entrée</PageTitle>

@if (Entry == null)
{
    <p>Chargement de l’entrée...</p>
}
else
{
    <section class="entry-details">
        <button class="entry-back-button" @onclick="BacktoVault">
            ← Retour au coffre
        </button>
        <div class="entry-card">
            <h2>@Entry.NomCypher</h2>
            
            <p><strong>Nom d'utilisateur :</strong> @Entry.UserNameCypher</p>
            <p><strong>Mot de passe :</strong> @Entry.PasswordCypher</p>
            <p><strong>Note :</strong> @Entry.NoteCypher</p>
            <p><strong>URL :</strong> @Entry.UrlCypher</p>
            <p><strong>Créé le :</strong> @Entry.CreatedAt.ToString("g")</p>
            @if (Entry.UpdatedAt.HasValue)
            {
                <p><strong>Mis à jour le :</strong> @Entry.UpdatedAt.Value.ToString("g")</p>
            }
            <p><strong>ID du coffre :</strong> @Entry.VaultId</p>
        </div>
    </section>
}

@code {
    [Parameter] public int id { get; set; }

    private EntryDisplayDto? Entry { get; set; }
    
    private void BacktoVault()
    {
        if (Entry is not null)
            Navigation.NavigateTo($"/VaultPage/{Entry.VaultId}");
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var vaultEntry = await EntryService.GetEntryByIdAsync(id);
            
            if (vaultEntry != null)
            {
                // Convertir VaultEntry en EntryDisplayDto pour l'affichage
                // Note: Les données chiffrées sont en byte[], il faudra les déchiffrer
                Entry = new EntryDisplayDto
                {
                    Id = vaultEntry.Id,
                    NomCypher = System.Text.Encoding.UTF8.GetString(vaultEntry.NomCypher?.Cypher ?? Array.Empty<byte>()),
                    UserNameCypher = System.Text.Encoding.UTF8.GetString(vaultEntry.UserNameCypher?.Cypher ?? Array.Empty<byte>()),
                    PasswordCypher = System.Text.Encoding.UTF8.GetString(vaultEntry.PasswordCypher?.Cypher ?? Array.Empty<byte>()),
                    NoteCypher = System.Text.Encoding.UTF8.GetString(vaultEntry.NoteCypher?.Cypher ?? Array.Empty<byte>()),
                    UrlCypher = System.Text.Encoding.UTF8.GetString(vaultEntry.UrlCypher?.Cypher ?? Array.Empty<byte>()),
                    CreatedAt = vaultEntry.CreatedAt,
                    UpdatedAt = vaultEntry.UpdatedAt,
                    VaultId = vaultEntry.VaultId
                };
                
                Logger.LogInformation("Entrée {EntryId} chargée avec succès", id);
            }
            else
            {
                Logger.LogWarning("Aucune entrée trouvée avec l'ID {EntryId}", id);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement de l'entrée {EntryId}", id);
        }
    }
}
